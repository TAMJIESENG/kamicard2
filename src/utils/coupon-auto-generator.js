// 每日优惠券自动生成器
// 每天自动生成6张公开优惠券，供用户领取

/**
 * 生成随机优惠券代码
 */
const generateCouponCode = () => {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
  let code = ''
  for (let i = 0; i < 8; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length))
  }
  return code
}

/**
 * 生成每日优惠券
 * 每天生成6张公开优惠券，先到先得
 */
export const generateDailyCoupons = () => {
  try {
    // 检查今天是否已经生成过优惠券
    const lastGenerateDate = localStorage.getItem('daily_coupons_generate_date')
    const today = new Date().toDateString()
    
    if (lastGenerateDate === today) {
      // 今天已经生成过，不需要重复生成
      return
    }
    
    // 获取现有优惠券
    const allCoupons = JSON.parse(localStorage.getItem('coupons') || '[]')
    
    // 生成6张优惠券，类型和折扣随机
    const newCoupons = []
    const couponTypes = [
      { type: 'percentage', values: [5, 10, 15, 20], names: ['限时折扣券', '特惠折扣券', '超值折扣券', '惊喜折扣券'] },
      { type: 'fixed', values: [5, 10, 15, 20, 30], names: ['现金抵扣券', '免单优惠券', '立减优惠券', '特价优惠券'] },
      { type: 'threshold', minAmounts: [50, 100, 150], discounts: [10, 15, 20, 25], names: ['满减优惠券', '满额立减券', '超值满减券'] }
    ]
    
    // 生成优惠券的有效期（从今天开始，7-30天有效）
    const validFrom = new Date()
    validFrom.setHours(0, 0, 0, 0)
    const validTo = new Date(validFrom)
    validTo.setDate(validTo.getDate() + 7 + Math.floor(Math.random() * 23)) // 7-30天有效期
    validTo.setHours(23, 59, 59, 999) // 设置为当天的最后时刻
    
    for (let i = 0; i < 6; i++) {
      const typeIndex = Math.floor(Math.random() * couponTypes.length)
      const couponType = couponTypes[typeIndex]
      
      let coupon = {
        id: `daily_${Date.now()}_${i}`,
        code: generateCouponCode(),
        name: '',
        description: '',
        type: couponType.type,
        isActive: true,
        isPublic: true, // 公开优惠券，任何人都可以领取
        userId: null,
        userIds: null,
        usedCount: 0,
        usageLimit: 1, // 每个用户只能使用一次
        validFrom: validFrom.toISOString(),
        validTo: validTo.toISOString(),
        createTime: new Date().toLocaleString('zh-CN'),
        minAmount: 0,
        discountAmount: 0
      }
      
      if (couponType.type === 'percentage') {
        const value = couponType.values[Math.floor(Math.random() * couponType.values.length)]
        const nameIndex = Math.floor(Math.random() * couponType.names.length)
        coupon.value = value
        coupon.name = `${couponType.names[nameIndex]} - ${value}%OFF`
        coupon.description = `满任意金额使用，享受${value}%折扣优惠`
      } else if (couponType.type === 'fixed') {
        const value = couponType.values[Math.floor(Math.random() * couponType.values.length)]
        const nameIndex = Math.floor(Math.random() * couponType.names.length)
        coupon.value = value
        coupon.name = `${couponType.names[nameIndex]} - ¥${value}`
        coupon.description = `满任意金额使用，立减¥${value}`
      } else if (couponType.type === 'threshold') {
        const minAmountIndex = Math.floor(Math.random() * couponType.minAmounts.length)
        const discountIndex = Math.floor(Math.random() * couponType.discounts.length)
        const minAmount = couponType.minAmounts[minAmountIndex]
        const discount = couponType.discounts[discountIndex]
        const nameIndex = Math.floor(Math.random() * couponType.names.length)
        coupon.minAmount = minAmount
        coupon.discountAmount = discount
        coupon.name = `${couponType.names[nameIndex]} - 满${minAmount}减${discount}`
        coupon.description = `订单满¥${minAmount}即可使用，立减¥${discount}`
      }
      
      newCoupons.push(coupon)
    }
    
    // 将新优惠券添加到列表中
    allCoupons.push(...newCoupons)
    localStorage.setItem('coupons', JSON.stringify(allCoupons))
    
    // 记录今天已经生成
    localStorage.setItem('daily_coupons_generate_date', today)
    localStorage.setItem('daily_coupons_count', newCoupons.length.toString())
    
    console.log(`✅ 已自动生成${newCoupons.length}张每日优惠券`)
    return newCoupons
  } catch (error) {
    console.error('生成每日优惠券失败:', error)
  }
}

/**
 * 初始化每日优惠券生成（在应用启动时调用）
 */
export const initializeDailyCoupons = () => {
  // 检查是否启用了每日优惠券自动生成功能
  try {
    const systemSettings = JSON.parse(localStorage.getItem('system_settings') || '{}')
    // 默认启用，除非明确关闭
    if (systemSettings.autoGenerateDailyCoupons === false) {
      return
    }
  } catch (error) {
    // 如果读取设置失败，默认启用
  }
  
  generateDailyCoupons()
}

